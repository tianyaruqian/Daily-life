
<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=9; IE=8; IE=7; IE=EDGE">
    <meta http-equiv="X-UA-Compatible" content="IE=EmulateIE7" />
    <title>结算页</title>

    <link rel="stylesheet" href="/js/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="/js/shop/css/webbase.css" />
    <link rel="stylesheet" type="text/css" href="/js/shop/css/pages-getOrderInfo.css" />
</head>

<body>
<!--head-->
<div class="top">
    <div id="nav"></div>

</div>
<div class="cart py-container">
    <!--logoArea-->
    <div class="logoArea">
        <div class="fl logo"><span class="title">结算页</span></div>
        <div class="fr search">

        </div>
    </div>
    <!--主内容-->
    <div class="checkout py-container">
        <div class="checkout-tit">
            <h4 class="tit-txt">填写并核对订单信息</h4>
        </div>
        <div class="checkout-steps">
            <!--收件人信息-->
            <div class="step-tit">
                <h5>收件人信息 <button type="button" class="btn btn btn-primary"onclick="addAddress()"><i class="glyphicon glyphicon-plus"></i>新增收货地址</button></h5>
            </div>
            <div class="step-cont">
                <div class="addressInfo">
                    <ul class="addr-detail">
                        <li class="addr-item">

                            <div id="address">

                            </div>

                        </li>
                    </ul>
    <!--添加地址-->
    <div style="display: none" id="addressDiv">
        <form class="form-horizontal">
            <div class="form-group">
                <label class="col-sm-2 control-label">收货人：</label>
                <div class="col-sm-4">
                    <input type="text" class="form-control" id="peopleName">
                </div>
           </div>
            <div class="form-group">
                <label class="col-sm-2 control-label">联系电话：</label>
                <div class="col-sm-4">
                    <input type="text"  class="form-control" id="mphone">
                </div>
            </div>
            <div class="form-group"  id="area">
                    <label class="col-sm-2 control-label">详细地址：</label>
            </div>

            <div class="form-group">
                <label class="col-sm-2 control-label">地址别名:</label>
                <div class="col-sm-4">
                    <input type="text"  class="form-control" id="otherName">
                </div>
                <div class="othername">
                    建议填写常用地址：<a href="#" class="sui-btn btn-default">家里</a>　<a href="#" class="sui-btn btn-default">父母家</a>　<a href="#" class="sui-btn btn-default">公司</a>
                </div>
            </div>
        </form>
    </div>
    <!--确认地址-->
        </div>
            <div class="hr"></div>

            </div>
            <div class="hr"></div>
            <!--支付和送货-->
            <div class="payshipInfo">
                <div class="step-tit">
                    <h5>支付方式</h5>
                </div>
                <div class="step-cont">
                    <ul class="payType">
                        <li class="selected">微信付款<span title="点击取消选择"></span></li>
                        <li>货到付款<span title="点击取消选择"></span></li>
                    </ul>
                </div>
                <div class="hr"></div>
                <div class="step-tit">
                    <h5>送货清单</h5>
                </div>
                <div class="step-cont" id="cartBody">

                </div>
                <div class="hr"></div>
            </div>
            <div class="linkInfo">
                <div class="step-tit">
                    <h5>发票信息</h5>
                </div>
                <div class="step-cont">
                    <span>普通发票（电子）</span>
                    <span>个人</span>
                    <span>明细</span>
                </div>
            </div>
            <div class="cardInfo">
                <div class="step-tit">
                    <h5>使用优惠/抵用</h5>
                </div>
            </div>
        </div>
    </div>
    <div class="order-summary">
        <div class="static fr" id="cartDiv">
        </div>
    </div>
    <div class="clearfix trade" id="priceInfo">

    </div>
    <div class="submit">
        <a class="sui-btn btn-danger btn-xlarge" href="javascript:;" onclick="submitOrder()">支付</a>
    </div>
</div>
<!-- 底部栏位 -->


<!--信息详情模板-->
<div style="display:none" id="template">
    <ul class="send-detail">
        <li>
            <div class="sendGoods">

                <ul class="yui3-g">
                    <li class="yui3-u-1-6">
                        <span><img src="###image###"/></span>
                    </li>
                    <li class="yui3-u-7-12">
                        <div class="desc">##productName##</div>
                        <div class="seven">7天无理由退货</div>
                    </li>
                    <li class="yui3-u-1-12">
                        <div class="price">￥##price##</div>
                    </li>
                    <li class="yui3-u-1-12">
                        <div class="num">X##count##</div>
                    </li>
                    <li class="yui3-u-1-12">
                        <div class="exit">有货</div>
                    </li>
                </ul>
            </div>
        </li>
        <li></li>
        <li></li>
    </ul>
</div>

<div style="display: none" id="cartInfo">
    <div class="list" >
        <span><i class="number">##totalCount##</i>件商品，总商品金额</span>
        <em class="allprice">¥##totalPrice##</em>
    </div>
    <div class="list">
        <span>返现：</span>
        <em class="money">0.00</em>
    </div>
    <div class="list">
        <span>运费：</span>
        <em class="transport">0.00</em>
    </div>
</div>

<div style="display: none" id="templatePrice">
    <div class="fc-price">应付金额:　<span class="price">¥##totalPrice##</span>
    </div>
    <div class="fc-receiverInfo">寄送至:##address##</div>
</div>


<!--库存不足显示-->
<div  style="display: none" id="shortProduct">
    <ul class="send-detail">
        <li>
            <div class="sendGoods">

                <ul class="yui3-g">
                    <li class="yui3-u-1-6">
                        <span><img src="###image###"/></span>
                    </li>
                    <li class="yui3-u-7-12">
                        <div class="desc">##productName##</div>
                        <div class="seven">7天无理由退货</div>
                    </li>
                    <li class="yui3-u-1-12">
                        <div class="price">￥##price##</div>
                    </li>
                    <li class="yui3-u-1-12">
                        <div class="num">X1</div>
                    </li>
                    <li class="yui3-u-1-12">
                        <div class="exit">有货</div>
                    </li>
                </ul>
            </div>
        </li>
        <li></li>
        <li></li>
    </ul>
</div>


<!--地址模板-->
<div style="display: none">
    <div class="con name selected"><a href="javascript:;">##m##<span title="点击取消选择"></span></a></div>
    <div class="con address">张默 北京市海淀区三环内 中关村软件园9号楼 <span>159****3201</span>
        <span class="base">默认地址</span>
        <span class="edittext"><a data-toggle="modal" data-target=".edit" data-keyboard="false" >编辑</a>&nbsp;&nbsp;<a href="javascript:;">删除</a></span>
    </div>
    <div class="clearfix"></div>
</div>
<!--页面底部-->
<div class="clearfix footer">
    <div class="py-container">
        <div class="footlink">
            <div class="Mod-service">
                <ul class="Mod-Service-list">
                    <li class="grid-service-item intro  intro1">

                        <i class="serivce-item fl"></i>
                        <div class="service-text">
                            <h4>正品保障</h4>
                            <p>正品保障，提供发票</p>
                        </div>

                    </li>
                    <li class="grid-service-item  intro intro2">

                        <i class="serivce-item fl"></i>
                        <div class="service-text">
                            <h4>正品保障</h4>
                            <p>正品保障，提供发票</p>
                        </div>

                    </li>
                    <li class="grid-service-item intro  intro3">

                        <i class="serivce-item fl"></i>
                        <div class="service-text">
                            <h4>正品保障</h4>
                            <p>正品保障，提供发票</p>
                        </div>

                    </li>
                    <li class="grid-service-item  intro intro4">

                        <i class="serivce-item fl"></i>
                        <div class="service-text">
                            <h4>正品保障</h4>
                            <p>正品保障，提供发票</p>
                        </div>

                    </li>
                    <li class="grid-service-item intro intro5">

                        <i class="serivce-item fl"></i>
                        <div class="service-text">
                            <h4>正品保障</h4>
                            <p>正品保障，提供发票</p>
                        </div>

                    </li>
                </ul>
            </div>
            <div class="clearfix Mod-list">
                <div class="yui3-g">
                    <div class="yui3-u-1-6">
                        <h4>购物指南</h4>
                        <ul class="unstyled">
                            <li>购物流程</li>
                            <li>会员介绍</li>
                            <li>生活旅行/团购</li>
                            <li>常见问题</li>
                            <li>购物指南</li>
                        </ul>

                    </div>
                    <div class="yui3-u-1-6">
                        <h4>配送方式</h4>
                        <ul class="unstyled">
                            <li>上门自提</li>
                            <li>211限时达</li>
                            <li>配送服务查询</li>
                            <li>配送费收取标准</li>
                            <li>海外配送</li>
                        </ul>
                    </div>
                    <div class="yui3-u-1-6">
                        <h4>支付方式</h4>
                        <ul class="unstyled">
                            <li>货到付款</li>
                            <li>在线支付</li>
                            <li>分期付款</li>
                            <li>邮局汇款</li>
                            <li>公司转账</li>
                        </ul>
                    </div>
                    <div class="yui3-u-1-6">
                        <h4>售后服务</h4>
                        <ul class="unstyled">
                            <li>售后政策</li>
                            <li>价格保护</li>
                            <li>退款说明</li>
                            <li>返修/退换货</li>
                            <li>取消订单</li>
                        </ul>
                    </div>
                    <div class="yui3-u-1-6">
                        <h4>特色服务</h4>
                        <ul class="unstyled">
                            <li>夺宝岛</li>
                            <li>DIY装机</li>
                            <li>延保服务</li>
                            <li>品优购E卡</li>
                            <li>品优购通信</li>
                        </ul>
                    </div>
                    <div class="yui3-u-1-6">
                        <h4>帮助中心</h4>
                    </div>
                </div>
            </div>
            <div class="Mod-copyright">
                <ul class="helpLink">
                    <li>关于我们<span class="space"></span></li>
                    <li>联系我们<span class="space"></span></li>
                    <li>关于我们<span class="space"></span></li>
                    <li>商家入驻<span class="space"></span></li>
                    <li>营销中心<span class="space"></span></li>
                    <li>友情链接<span class="space"></span></li>
                    <li>关于我们<span class="space"></span></li>
                    <li>营销中心<span class="space"></span></li>
                    <li>友情链接<span class="space"></span></li>
                    <li>关于我们</li>
                </ul>
            </div>
        </div>
    </div>
</div>
<!--页面底部END-->

<script src="/js/jquery-3.3.1.js"></script>
<script type="text/javascript" src="/js/shop/js/plugins/jquery.easing/jquery.easing.min.js"></script>
<script type="text/javascript" src="/js/shop/js/plugins/sui/sui.min.js"></script>
<script type="text/javascript" src="/js/shop/js/pages/getOrderInfo.js"></script>
<script src="/js/jquery.cookie.min.js"></script>
<script src="/js/bootstrap/js/bootstrap.min.js"></script>
<script src="/js/bootbox/bootbox.min.js"></script>
<script src="/js/bootbox/bootbox.locales.min.js"></script>
<script src="/common/nav.js"></script>

<script>
    var addressDiv;
    $(function () {
        initCart();
        getToken();
        addressDiv =$("#addressDiv").html();
    })

    //地址新增
    var v_Address;
    function addAddress() {
        initArea(1)
      v_Address= bootbox.dialog({
            size:"large",
            title:"新增地址",
            message: $("#addressDiv form"),
            backdrop:false,
            buttons: {
                confirm: {
                    label: '<span class="glyphicon glyphicon-ok">保存</span>',
                    className: 'btn-success',
                    callback: function () {
                        var param={};
                        var a1=$($("select[name='area']")[0]).val();
                        var a2=$($("select[name='area']")[1]).val();
                        var a3=$($("select[name='area']")[2]).val();

                        param.mphone =$("#mphone",v_Address).val();
                        param.province =a1;
                        param.city=a2;
                        param.country=a3;
                        param.otherName=$("#otherName",v_Address).val();
                        param.peopleName=$("#peopleName",v_Address).val();
                        console.log(param);
                        $.ajax({
                            url: "http://localhost:8086/address",
                            type: "post",
                            data: param,
                            success: function (res) {
                                if (res.code==200) {
                                    bootbox.alert({
                                        size: "small",
                                        title: "用户状态",
                                        message: "新增成功",
                                    })

                                }  else{
                                    bootbox.alert({
                                        size: "small",
                                        title: "用户状态",
                                        message: "新增失败",
                                    })
                                }

                            }
                        })
                    }
                },
                cancel: {
                    label: '<span class="lyphicon glyphicon-remove">取消</span>',
                    className: 'btn-danger'
                }
            },
        })
        $("#addressDiv").html(addressDiv);
    }
    //地址三级
    function initArea(id ,obj){
        if(obj){
            $(obj).parent().nextAll().remove();
        }
        $.ajax({
            url:"http://localhost:8086/areas",
            type:"get",
            data:{"id":id},
            success:function (res) {
                if(res.code==200){
                    var v_areaList= res.data;
                    //解决没有值继续无限弹出框
                    if(!v_areaList.length>0){
                        return;
                    }
                    var html = '<div class="col-sm-2"><select class="form-control" name="area" onchange="initArea(this.value,this)">'
                    html+='<option value="-1">请选择</option>';
                    for(var i =0;i<v_areaList.length;i++ ){
                        var area = v_areaList[i];
                        html+='<option value="'+area.id+'">'+area.areaName+'</option>'
                    }
                    html+="</select></div>"
                    $("#area",v_Address).append(html);
                }
            }
        })

    }
   //获取token
    var token;
    function getToken() {
        $.ajax({
            type:"get",
            url:"http://localhost:8086/tokens",
            success:function (res) {
                token = res.data;
            }

        })
    }


   //提交订单
   function submitOrder() {
       $.ajax({
           type: "post",
           url: "http://localhost:8086/order",
           beforeSend: function (req) {
               //取出头信息cookies;
               var cookie = $.cookie("data_auth");
               //赋值给头信息中
               req.setRequestHeader("x-token", cookie);
               req.setRequestHeader("token", token);
           },
           data: {"payType": 1},
           success: function (res) {
               if (res.code == 200) {
                   var dataList = res.data;
                   //库存足够
                   if (dataList.length == 0) {
                       location.href = "/pay.html";
                   } else {
                       //弹出提示框，显示库存不足的产品
                       var cartPro = dataList.list;
                       var cartTemplate = $("#shortProduct").html();
                       var shortResult = "";
                       for (var i = 0; i < cartPro.length; i++) {
                           var product = cartPro[i];
                           var result = cartTemplate.replace(/###image###/g, product.image).replace(/##price##/g, product.productPrice)
                               .replace(/##count##/g, product.count)
                               .replace(/##productName##/g, product.productName)
                               .replace(/##pid##/g, product.id)
                               .replace(/##sumPrice##/g, product.subtotal);
                           shortResult = result;
                       }


                       bootbox.dialog({
                           title: "库存信息",
                           backdrop:false,
                           message: shortResult,
                           buttons: {
                               confirm: {
                                   label: '<span class="glyphicon glyphicon-ok">保存</span>',
                                   className: 'btn-success',
                                   callback: function () {
                                       location.href = "/pay.html";
                                   }


                               }
                           }

                       })
                   }
               }else if(res.code==2019){
                   bootbox.dialog({
                       title: "库存信息",
                       message: res.msg,
                       backdrop:false,
                        size:"small",
                   })

               }
           }
       })
   }
</script>
</body>

</html>